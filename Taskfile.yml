version: '3'

tasks:
  # ============================================================================
  # Top-level tasks
  # ============================================================================

  default:
    desc: "Run all checks"
    cmds:
      - task: check

  lint:
    desc: "Run all linters"
    cmds:
      - task: buf:lint
      - task: rust:clippy

  fmt:
    desc: "Format all code"
    cmds:
      - task: buf:format
      - task: rust:fmt

  fmt:check:
    desc: "Check formatting without modifying files"
    cmds:
      - task: buf:format:check
      - task: rust:fmt:check

  build:
    desc: "Build all code"
    cmds:
      - task: gen
      - task: rust:build

  test:
    desc: "Run all tests"
    cmds:
      - task: rust:test

  check:
    desc: "Run all checks (fmt, lint, audit, deny)"
    cmds:
      - task: fmt:check
      - task: lint
      - task: rust:audit
      - task: rust:deny

  # ============================================================================
  # Setup tasks
  # ============================================================================

  setup:
    desc: "Setup development environment"
    cmds:
      - task: setup:signing
      - task: setup:cocogitto
      - task: setup:vacuum
      - task: setup:openapi-generator
      - task: setup:hooks
      - task: setup:tools

  setup:cocogitto:
    desc: "Setup cocogitto"
    cmds:
      - task: setup:cocogitto:check
      - task: setup:cocogitto:config

  setup:vacuum:
    desc: "Setup vacuum"
    cmds:
      - task: setup:vacuum:check

  setup:openapi-generator:
    desc: "Setup openapi-generator"
    cmds:
      - task: setup:openapi-generator:check

  setup:openapi-generator:check:
    desc: "Check if openapi-generator is installed"
    cmds:
      - |
        if ! command -v openapi-generator >/dev/null 2>&1; then
          echo "⚠️  openapi-generator not found"
          echo "Please install: brew install openapi-generator"
        fi
    silent: true

  setup:signing:
    desc: "Configure SSH commit signing"
    cmds:
      - |
        echo "Configuring commit signing..."
        
        ALLOWED_DOMAINS="@pistachiohq.com"
        
        git config commit.gpgsign true
        git config gpg.format ssh
        
        EMAIL=$(git config user.email)
        SIGNING_KEY=$(git config user.signingkey)
        
        if [[ -z "$EMAIL" ]] || [[ -z "$SIGNING_KEY" ]]; then
          echo "Error: Missing configuration"
          echo "Run: git config user.email your-email@pistachiohq.com"
          echo "Run: git config user.signingkey ~/.ssh/id_ed25519.pub"
          exit 1
        fi
        
        VALID_DOMAIN=false
        for domain in $ALLOWED_DOMAINS; do
          if [[ "$EMAIL" == *"$domain" ]]; then
            VALID_DOMAIN=true
            break
          fi
        done
        
        if [[ "$VALID_DOMAIN" != "true" ]]; then
          echo "Error: Email '$EMAIL' is not from an authorized domain"
          echo "Allowed domains: $ALLOWED_DOMAINS"
          echo "Run: git config user.email your-email@pistachiohq.com"
          exit 1
        fi
        
        mkdir -p .git

        if [[ -f "$SIGNING_KEY" ]]; then
          echo "$EMAIL $(cat $SIGNING_KEY)" > .git/allowed_signers
        else
          echo "$EMAIL $SIGNING_KEY" > .git/allowed_signers
        fi
        
        git config gpg.ssh.allowedSignersFile .git/allowed_signers
        
        echo "✓ SSH signing configured for $EMAIL"
    status:
      - test -f .git/allowed_signers
      - git config --get gpg.ssh.allowedSignersFile | grep -q ".git/allowed_signers"
    
  setup:cocogitto:check:
    desc: "Check if cocogitto is installed"
    cmds:
      - |
        if ! command -v cog >/dev/null 2>&1; then
          echo "⚠️  cocogitto not found"
          echo "Please install: brew install cocogitto"
          echo "Or: cargo install cocogitto"
        fi
    silent: true

  setup:vacuum:check:
    desc: "Check if vacuum is installed"
    cmds:
      - |
        if ! command -v vacuum >/dev/null 2>&1; then
          echo "⚠️  vacuum not found"
          echo "Please install: brew install daveshanley/vacuum/vacuum"
        fi
    silent: true

  setup:cocogitto:config:
    desc: "Setup cocogitto configuration"
    cmds:
      - |
        echo '# Cocogitto configuration
        # https://docs.cocogitto.io/config

        [commit_types]
        build = { changelog_title = "Build System" }
        chore = { changelog_title = "Chores" }
        ci = { changelog_title = "Continuous Integration" }
        docs = { changelog_title = "Documentation" }
        feat = { changelog_title = "Features" }
        fix = { changelog_title = "Bug Fixes" }
        perf = { changelog_title = "Performance" }
        refactor = { changelog_title = "Refactoring" }
        revert = { changelog_title = "Reverts" }
        style = { changelog_title = "Styles" }
        test = { changelog_title = "Tests" }
        
        [commit_scopes]
        auth = {}
        api = {}
        ui = {}
        docs = {}
        deps = {}
        
        [changelog]
        path = "CHANGELOG.md"
        template = "default"
        
        [bump_profiles]
        default = { build = "patch", chore = "patch" }
        ' > cog.toml
    status:
      - test -f cog.toml

  setup:hooks:
    desc: "Install git hooks via lefthook"
    cmds:
      - lefthook install
    status:
      - test -f .git/hooks/prepare-commit-msg || test -f .git/hooks/lefthook-run

  setup:tools:
    desc: "Check required tools are installed"
    cmds:
      - |
        MISSING=""

        if ! command -v cargo-audit >/dev/null 2>&1; then
          MISSING="${MISSING}cargo-audit (cargo install cargo-audit)\n"
        fi

        if ! command -v cargo-deny >/dev/null 2>&1; then
          MISSING="${MISSING}cargo-deny (cargo install cargo-deny)\n"
        fi

        if ! command -v cross >/dev/null 2>&1; then
          MISSING="${MISSING}cross (cargo install cross)\n"
        fi

        if [ -n "$MISSING" ]; then
          echo "Missing tools:"
          echo -e "$MISSING"
        else
          echo "All tools installed"
        fi
    silent: true

  # ============================================================================
  # Changelog tasks
  # ============================================================================

  changelog:
    desc: "Generate changelog from conventional commits"
    cmds:
      - cog changelog

  changelog:check:
    desc: "Verify all commits follow conventional commit format"
    cmds:
      - cog check

  bump:check:
    desc: "Check for breaking proto changes without matching BREAKING CHANGE commits"
    cmds:
      - |
        # Check for breaking proto changes
        if buf breaking --against '.git#branch=main' 2>/dev/null; then
          echo "✓ No breaking proto changes detected"
          exit 0
        fi

        # Breaking changes detected - check for BREAKING CHANGE commits
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

        if [[ -z "$LAST_TAG" ]]; then
          COMMIT_RANGE="HEAD"
        else
          COMMIT_RANGE="${LAST_TAG}..HEAD"
        fi

        # Look for BREAKING CHANGE in commit bodies or footers
        if git log "$COMMIT_RANGE" --format="%B" | grep -q "BREAKING CHANGE"; then
          echo "✓ Breaking proto changes detected with matching BREAKING CHANGE commit(s)"
          exit 0
        fi

        # Also check for commits with ! after type (e.g., feat!: or fix(scope)!:)
        if git log "$COMMIT_RANGE" --format="%s" | grep -qE "^[a-z]+(\([^)]+\))?!:"; then
          echo "✓ Breaking proto changes detected with matching breaking commit(s)"
          exit 0
        fi

        echo "⚠️  ERROR: Breaking proto changes detected but no BREAKING CHANGE commits found"
        echo ""
        echo "Breaking changes were detected by 'buf breaking'. To proceed, you must:"
        echo "1. Add a commit with 'BREAKING CHANGE:' in the footer, or"
        echo "2. Use '!' after the type (e.g., 'feat!: remove deprecated field')"
        echo ""
        echo "Run 'buf breaking --against .git#branch=main' to see the breaking changes."
        exit 1
    silent: true

  bump:
    desc: "Bump version and update changelog"
    deps: [bump:check]
    cmds:
      - cog bump --auto

  bump:dry-run:
    desc: "Preview version bump without making changes"
    deps: [bump:check]
    cmds:
      - cog bump --auto --dry-run

  # ============================================================================
  # Buf / Protobuf tasks
  # ============================================================================

  buf:lint:
    desc: "Lint protobuf files with buf"
    cmds:
      - buf lint

  buf:format:
    desc: "Format protobuf files with buf"
    cmds:
      - buf format -w

  buf:format:check:
    desc: "Check protobuf formatting without modifying files"
    cmds:
      - buf format --diff --exit-code

  buf:breaking:
    desc: "Check for breaking changes against main branch"
    cmds:
      - buf breaking --against '.git#branch=main'

  buf:deps:
    desc: "Update and export buf dependencies"
    cmds:
      - buf dep update
      - rm -rf gen/proto-deps
      - buf export buf.build/bufbuild/protovalidate --output gen/proto-deps
    sources:
      - buf.yaml
      - buf.lock
    generates:
      - gen/proto-deps/**/*.proto

  # ============================================================================
  # OpenAPI tasks
  # ============================================================================

  openapi:lint:
    desc: "Lint OpenAPI specs (lints bundled output to properly resolve all references)"
    dir: openapi
    deps: [openapi:bundle]
    cmds:
      - vacuum lint bundled.yml
      - vacuum lint admin-bundled.yml

  openapi:lint:details:
    desc: "Lint OpenAPI specs with detailed output"
    dir: openapi
    deps: [openapi:bundle]
    cmds:
      - vacuum lint bundled.yml --details
      - vacuum lint admin-bundled.yml --details

  openapi:bundle:
    desc: "Bundle OpenAPI specs into single files"
    dir: openapi
    cmds:
      - vacuum bundle pistachio-api.yml bundled.yml
      - vacuum bundle pistachio-admin-api.yml admin-bundled.yml
    sources:
      - ./**/*.yml
    generates:
      - bundled.yml
      - admin-bundled.yml


  # ============================================================================
  # Code generation tasks
  # ============================================================================

  gen:rust:
    desc: "Generate Rust code from protobuf definitions"
    dir: gen/rust
    cmds:
      - cargo build
    sources:
      - ../../proto/**/*.proto
      - ../../gen/proto-deps/**/*.proto
      - build.rs
      - Cargo.toml
    generates:
      - target/debug/build/pistachio-api-*/out/*.rs

  gen:
    desc: "Generate all code from protobuf definitions"
    cmds:
      - task: buf:deps
      - task: gen:rust

  # ============================================================================
  # Rust tasks
  # ============================================================================

  rust:build:
    desc: "Build all Rust code"
    cmds:
      - cd rust && cargo build
      - cd gen/rust && cargo build

  rust:test:
    desc: "Run Rust tests"
    cmds:
      - cd rust && cargo test
      - cd gen/rust && cargo test

  rust:clippy:
    desc: "Run clippy on Rust code"
    cmds:
      - cd rust && cargo clippy --workspace --all-targets --all-features -- -D warnings
      - cd gen/rust && cargo clippy --all-targets --all-features -- -D warnings

  rust:fmt:
    desc: "Format Rust code"
    cmds:
      - cd rust && cargo fmt
      - cd gen/rust && cargo fmt

  rust:fmt:check:
    desc: "Check Rust formatting without modifying files"
    cmds:
      - cd rust && cargo fmt --check
      - cd gen/rust && cargo fmt --check

  rust:audit:
    desc: "Check for security vulnerabilities in dependencies"
    cmds:
      - cd rust && cargo audit --deny warnings
      - cd gen/rust && cargo audit --deny warnings

  rust:deny:
    desc: "Check dependencies against policy (licenses, bans, advisories)"
    cmds:
      - cd rust && cargo deny --all-features check --deny warnings --allow unmatched-organization
      - cd gen/rust && cargo deny --all-features check --deny warnings

  rust:update:
    desc: "Update dependencies to latest compatible versions"
    cmds:
      - cd rust && cargo update
      - cd gen/rust && cargo update

  rust:update:nightly:
    desc: "Update dependencies with nightly toolchain"
    cmds:
      - cd rust && cargo +nightly update
      - cd gen/rust && cargo +nightly update

  rust:update:nightly:minimal-versions:
    desc: "Update dependencies to minimal versions (nightly only)"
    cmds:
      - cd rust && rm -f Cargo.lock && cargo +nightly update -Z minimal-versions
      - cd gen/rust && rm -f Cargo.lock && cargo +nightly update -Z minimal-versions

  rust:build:nightly:
    desc: "Build with nightly toolchain"
    cmds:
      - cd rust && cargo +nightly build
      - cd gen/rust && cargo +nightly build

  rust:build:nightly:minimal-versions:
    desc: "Build with minimal dependency versions (nightly only)"
    cmds:
      - cd rust && cargo +nightly update -Z minimal-versions && cargo +nightly build
      - cd gen/rust && cargo +nightly update -Z minimal-versions && cargo +nightly build

  rust:test:nightly:
    desc: "Run tests with nightly toolchain"
    cmds:
      - cd rust && cargo +nightly test
      - cd gen/rust && cargo +nightly test

  rust:build:release:
    desc: "Build in release mode"
    cmds:
      - cd rust && cargo build --release
      - cd gen/rust && cargo build --release

  rust:build:msrv:
    desc: "Build with MSRV (1.86) toolchain"
    cmds:
      - cd rust && rm -f Cargo.lock && cargo +1.86 build
      - cd gen/rust && rm -f Cargo.lock && cargo +1.86 build

  rust:test:msrv:
    desc: "Run tests with MSRV (1.86) toolchain"
    cmds:
      - cd rust && rm -f Cargo.lock && cargo +1.86 test
      - cd gen/rust && rm -f Cargo.lock && cargo +1.86 test

  rust:build:msrv:minimal-versions:
    desc: "Build with MSRV (1.86) using minimal dependency versions"
    cmds:
      - cd rust && rm -f Cargo.lock && cargo +nightly update -Z minimal-versions && cargo +1.86 build
      - cd gen/rust && rm -f Cargo.lock && cargo +nightly update -Z minimal-versions && cargo +1.86 build

  rust:test:msrv:minimal-versions:
    desc: "Run tests with MSRV (1.86) using minimal dependency versions"
    cmds:
      - cd rust && rm -f Cargo.lock && cargo +nightly update -Z minimal-versions && cargo +1.86 test
      - cd gen/rust && rm -f Cargo.lock && cargo +nightly update -Z minimal-versions && cargo +1.86 test

  # ============================================================================
  # CI tasks
  # ============================================================================

  ci:lint:
    desc: "Run all linting checks for CI"
    cmds:
      - task: buf:lint
      - task: rust:clippy

  ci:fmt:
    desc: "Format check for CI"
    cmds:
      - task: buf:format:check
      - task: rust:fmt:check

  ci:build:
    desc: "Build all generated code for CI"
    cmds:
      - task: gen

  ci:test:
    desc: "Test for CI"
    cmds:
      - task: rust:test

  ci:security:
    desc: "Security checks for CI"
    cmds:
      - task: rust:audit
      - cd rust && cargo deny --all-features check --deny warnings
      - cd gen/rust && cargo deny --all-features check --deny warnings

  # ============================================================================
  # Cross-compilation tasks
  # ============================================================================

  cross:build:
    desc: "Cross-compile for all Linux targets"
    cmds:
      - task: cross:build:x86_64
      - task: cross:build:aarch64

  cross:build:release:
    desc: "Cross-compile release builds for all Linux targets"
    cmds:
      - task: cross:build:x86_64:release
      - task: cross:build:aarch64:release

  cross:build:x86_64:
    desc: "Cross-compile for x86_64-unknown-linux-gnu"
    cmds:
      - cd rust && cross build --target x86_64-unknown-linux-gnu
      - cd gen/rust && cross build --target x86_64-unknown-linux-gnu

  cross:build:x86_64:release:
    desc: "Cross-compile release for x86_64-unknown-linux-gnu"
    cmds:
      - cd rust && cross build --release --target x86_64-unknown-linux-gnu
      - cd gen/rust && cross build --release --target x86_64-unknown-linux-gnu

  cross:build:aarch64:
    desc: "Cross-compile for aarch64-unknown-linux-gnu"
    cmds:
      - cd rust && cross build --target aarch64-unknown-linux-gnu
      - cd gen/rust && cross build --target aarch64-unknown-linux-gnu

  cross:build:aarch64:release:
    desc: "Cross-compile release for aarch64-unknown-linux-gnu"
    cmds:
      - cd rust && cross build --release --target aarch64-unknown-linux-gnu
      - cd gen/rust && cross build --release --target aarch64-unknown-linux-gnu

  cross:test:
    desc: "Run tests via cross for all Linux targets"
    cmds:
      - task: cross:test:x86_64
      - task: cross:test:aarch64

  cross:test:x86_64:
    desc: "Run tests via cross for x86_64-unknown-linux-gnu"
    cmds:
      - cd rust && cross test --target x86_64-unknown-linux-gnu
      - cd gen/rust && cross test --target x86_64-unknown-linux-gnu

  cross:test:aarch64:
    desc: "Run tests via cross for aarch64-unknown-linux-gnu"
    cmds:
      - cd rust && cross test --target aarch64-unknown-linux-gnu
      - cd gen/rust && cross test --target aarch64-unknown-linux-gnu
