# Authentication Flow schemas for Public API

# =============================================================================
# Token Responses
# =============================================================================

TokenResponse:
  type: object
  description: Response containing authentication tokens.
  required:
    - idToken
    - refreshToken
    - expiresIn
  properties:
    idToken:
      type: string
      description: |
        JWT ID token for authenticating API requests.
        Include this in the Authorization header as "Bearer {idToken}".
      example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
    refreshToken:
      type: string
      description: |
        Refresh token for obtaining new ID tokens.
        Use this with the token refresh endpoint when the ID token expires.
      example: AMf-vBw7abc123def456...
    expiresIn:
      type: integer
      format: int64
      description: Number of seconds until the ID token expires.
      example: 3600
    pistachioId:
      type: string
      description: The user's pistachio_id.
      pattern: '^[a-fA-F0-9]{30}00$'
      example: a1b2c3d4e5f6789012345678901234500
    isNewUser:
      type: boolean
      description: Whether this is a newly created user (for anonymous auth).
      example: false

# =============================================================================
# Sign Out
# =============================================================================

SignOutRequest:
  type: object
  description: Request body for signing out.
  properties:
    refreshToken:
      type: string
      description: |
        Optional refresh token to revoke.
        If not provided, only the current session is invalidated.
      example: AMf-vBw7abc123def456...
    allSessions:
      type: boolean
      description: |
        Whether to revoke all sessions for the user.
        Requires a valid ID token in the Authorization header.
      default: false
      example: false

# =============================================================================
# Token Operations
# =============================================================================

RefreshTokenRequest:
  type: object
  description: Request body for refreshing tokens.
  required:
    - refreshToken
  properties:
    refreshToken:
      type: string
      description: The refresh token to exchange for new tokens.
      example: AMf-vBw7abc123def456...

ExchangeTokenRequest:
  type: object
  description: Request body for exchanging a custom token for ID tokens.
  required:
    - customToken
  properties:
    customToken:
      type: string
      description: |
        The custom token received from your server.
        Custom tokens are created using the Admin API's createCustomToken endpoint.
      example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...

# =============================================================================
# Email Verification
# =============================================================================

SendEmailVerificationRequest:
  type: object
  description: Request body for sending an email verification link.
  properties:
    continueUrl:
      type: string
      format: uri
      description: |
        Optional URL to redirect to after email verification.
        Must be whitelisted in the project's authorized domains.
      example: "https://myapp.com/verified"

SendEmailVerificationResponse:
  type: object
  description: Response confirming email verification was sent.
  properties:
    email:
      type: string
      format: email
      description: The email address the verification was sent to.
      example: user@example.com

ConfirmEmailVerificationRequest:
  type: object
  description: Request body for confirming email verification.
  required:
    - oobCode
  properties:
    oobCode:
      type: string
      description: |
        The out-of-band verification code from the email link.
      example: abc123def456

ConfirmEmailVerificationResponse:
  type: object
  description: Response confirming email was verified.
  properties:
    email:
      type: string
      format: email
      description: The verified email address.
      example: user@example.com
    emailVerified:
      type: boolean
      description: Confirmation that the email is now verified.
      example: true

# =============================================================================
# Anonymous Authentication
# =============================================================================

AnonymousAuthRequest:
  type: object
  description: Request body for anonymous authentication.
  properties:
    tenantId:
      type:
        - string
        - 'null'
      description: Optional tenant ID for multi-tenant projects.
      example: my-tenant

# =============================================================================
# OAuth/OIDC
# =============================================================================

OAuthAuthorizeParams:
  type: object
  description: Query parameters for OAuth authorize redirect.
  properties:
    redirectUri:
      type: string
      format: uri
      description: |
        The URI to redirect to after authorization.
        Must be registered in the project's authorized redirect URIs.
      example: "https://myapp.com/callback"
    state:
      type: string
      description: |
        Opaque value for maintaining state between request and callback.
        Use this to prevent CSRF attacks.
      maxLength: 1024
      example: "random-state-value"
    scopes:
      type: array
      items:
        type: string
      description: |
        OAuth scopes to request from the provider.
        Default scopes (email, profile) are always included.
      example:
        - email
        - profile
    tenantId:
      type: string
      description: Optional tenant ID for multi-tenant projects.
      example: my-tenant

OAuthCallbackRequest:
  type: object
  description: Request body for OAuth callback processing.
  required:
    - code
    - state
  properties:
    code:
      type: string
      description: The authorization code from the OAuth provider.
      example: 4/0AX4XfWh...
    state:
      type: string
      description: The state parameter from the original authorize request.
      example: random-state-value
    redirectUri:
      type: string
      format: uri
      description: The redirect URI used in the authorize request.
      example: "https://myapp.com/callback"

# =============================================================================
# Auth Providers
# =============================================================================

AuthProvider:
  type: object
  description: An available authentication provider.
  properties:
    providerId:
      type: string
      description: Provider identifier.
      example: google.com
    providerType:
      type: string
      enum:
        - PDPKA
        - OAUTH
        - OIDC
        - SAML
        - ANONYMOUS
      description: The type of authentication provider.
      example: OAUTH
    displayName:
      type:
        - string
        - 'null'
      description: Human-readable name for the provider.
      example: Google
    enabled:
      type: boolean
      description: Whether the provider is enabled.
      example: true

ListAuthProvidersResponse:
  type: object
  description: Response containing available auth providers.
  properties:
    providers:
      type: array
      description: List of available authentication providers.
      items:
        $ref: '#/AuthProvider'

# =============================================================================
# MFA (Public API)
# =============================================================================

MfaFactor:
  type: object
  description: An MFA factor enrolled by the user.
  properties:
    factorId:
      type: string
      description: Unique factor identifier.
      example: factor-abc123
    factorType:
      type: string
      enum:
        - TOTP
        - SMS
        - EMAIL
      description: The type of MFA factor.
      example: TOTP
    displayName:
      type:
        - string
        - 'null'
      description: User-provided name for the factor.
      example: My Authenticator
    verified:
      type: boolean
      description: Whether the factor has been verified.
      example: true
    createdAt:
      type: string
      format: date-time
      description: When the factor was enrolled.
      example: "2024-01-15T10:30:00Z"

ListMfaFactorsResponse:
  type: object
  description: Response containing the user's MFA factors.
  properties:
    factors:
      type: array
      items:
        $ref: '#/MfaFactor'

EnrollMfaFactorRequest:
  type: object
  description: Request body for enrolling an MFA factor.
  required:
    - factorType
  properties:
    factorType:
      type: string
      enum:
        - TOTP
        - SMS
        - EMAIL
      description: The type of factor to enroll.
      example: TOTP
    displayName:
      type: string
      description: User-provided name for the factor.
      maxLength: 256
      example: My Authenticator
    phoneNumber:
      type: string
      pattern: '^\+[1-9]\d{1,14}$'
      description: Phone number for SMS factor (E.164 format).
      example: "+14155551234"

EnrollMfaFactorResponse:
  type: object
  description: Response containing enrollment information.
  properties:
    factorId:
      type: string
      description: The ID of the enrolled factor.
      example: factor-abc123
    totpSecret:
      type: string
      description: |
        Base32-encoded TOTP secret (for TOTP factors).
        Display this as a QR code or manual entry key.
      example: JBSWY3DPEHPK3PXP
    totpUri:
      type: string
      format: uri
      description: |
        otpauth:// URI for TOTP factors.
        Can be encoded as a QR code for authenticator apps.
      example: "otpauth://totp/Pistachio:user@example.com?secret=JBSWY3DPEHPK3PXP&issuer=Pistachio"
    challengeId:
      type: string
      description: |
        Challenge ID for SMS/email factors.
        A verification code was sent to the phone/email.
      example: challenge-xyz789

VerifyMfaFactorRequest:
  type: object
  description: Request body for verifying an MFA factor during enrollment.
  required:
    - code
  properties:
    code:
      type: string
      description: |
        The verification code.
        For TOTP: current 6-digit code from authenticator app.
        For SMS/email: the code sent to the phone/email.
      pattern: '^\d{6}$'
      example: "123456"

VerifyMfaFactorResponse:
  type: object
  description: Response confirming factor verification.
  properties:
    verified:
      type: boolean
      description: Whether the factor was successfully verified.
      example: true
    factor:
      $ref: '#/MfaFactor'

ChallengeMfaFactorRequest:
  type: object
  description: Request body for initiating an MFA challenge.
  required:
    - recaptchaToken
  properties:
    recaptchaToken:
      type: string
      description: |
        reCAPTCHA token required for bot protection when sending SMS/email codes.

ChallengeMfaFactorResponse:
  type: object
  description: Response containing the MFA challenge.
  properties:
    challengeId:
      type: string
      description: |
        Challenge ID to use when verifying.
        For SMS/email factors, a code was sent.
      example: challenge-xyz789
    expiresAt:
      type: string
      format: date-time
      description: When the challenge expires.
      example: "2024-01-15T10:35:00Z"

CompleteMfaChallengeRequest:
  type: object
  description: Request body for completing an MFA challenge.
  required:
    - challengeId
    - code
  properties:
    challengeId:
      type: string
      description: The challenge ID from the MFA challenge response.
      example: challenge-xyz789
    code:
      type: string
      description: |
        The verification code.
        For TOTP: current 6-digit code from authenticator app.
        For SMS/email: the code sent to the phone/email.
      pattern: '^\d{6}$'
      example: "123456"

# =============================================================================
# Recovery Codes
# =============================================================================

GenerateRecoveryCodesResponse:
  type: object
  description: |
    Response containing newly generated recovery codes.
    IMPORTANT: These codes are only shown once. Store them securely offline.
  properties:
    recoveryCodes:
      type: array
      description: |
        The generated recovery codes. Typically 10 codes, each usable only once.
        Store these codes securely offline. They cannot be retrieved again.
      items:
        type: string
      example:
        - "ABCD-EFGH-IJKL"
        - "MNOP-QRST-UVWX"
        - "YZAB-CDEF-GHIJ"

GetRecoveryCodeCountResponse:
  type: object
  description: Response containing the count of remaining recovery codes.
  properties:
    remainingCount:
      type: integer
      format: int32
      description: Number of unused recovery codes remaining.
      example: 8
    totalCount:
      type: integer
      format: int32
      description: Total number of recovery codes originally generated.
      example: 10

VerifyRecoveryCodeRequest:
  type: object
  description: Request body for verifying a recovery code during MFA challenge.
  required:
    - challengeId
    - recoveryCode
  properties:
    challengeId:
      type: string
      description: The challenge ID from the MFA challenge response.
      example: challenge-xyz789
    recoveryCode:
      type: string
      description: |
        The recovery code to verify.
        Format: XXXX-XXXX-XXXX (alphanumeric with hyphens).
      pattern: '^[A-Z0-9-]+$'
      example: "ABCD-EFGH-IJKL"

VerifyRecoveryCodeResponse:
  type: object
  description: Response after successfully verifying a recovery code.
  properties:
    idToken:
      type: string
      description: JWT ID token for authenticating API requests.
      example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
    refreshToken:
      type: string
      description: Refresh token for obtaining new ID tokens.
      example: AMf-vBw7abc123def456...
    expiresIn:
      type: integer
      format: int64
      description: Number of seconds until the ID token expires.
      example: 3600
    pistachioId:
      type: string
      description: The user's pistachio_id.
      example: a1b2c3d4e5f6789012345678901234500
    remainingCodes:
      type: integer
      format: int32
      description: Number of recovery codes remaining after this use.
      example: 7
