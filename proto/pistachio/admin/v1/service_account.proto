syntax = "proto3";

package pistachio.admin.v1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "pistachio/types/v1/pagination.proto";
import "pistachio/types/v1/search.proto";
import "pistachio/types/v1/service_account.proto";

// =============================================================================
// Service Account Operations
// =============================================================================

// CreateServiceAccountRequest creates a new service account within a project.
message CreateServiceAccountRequest {
  // The project ID that will own this service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // Desired service account ID.
  // Optional. If not provided, one will be generated.
  // Must be 4-128 characters, lowercase alphanumeric with hyphens.
  string service_account_id = 2 [(buf.validate.field) = {
    ignore: IGNORE_IF_ZERO_VALUE
    string: {
      min_len: 4
      max_len: 128
      pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
    }
  }];

  // Human-readable display name.
  // Required. Max 256 characters.
  string display_name = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 256
  }];

  // Optional description of the service account's purpose.
  // Max 1000 characters.
  string description = 4 [(buf.validate.field).string.max_len = 1000];
}

// CreateServiceAccountResponse contains the newly created service account.
message CreateServiceAccountResponse {
  // The created service account.
  pistachio.types.v1.ServiceAccount service_account = 1;
}

// GetServiceAccountRequest retrieves a service account by ID.
message GetServiceAccountRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];
}

// GetServiceAccountResponse contains the requested service account.
message GetServiceAccountResponse {
  // The retrieved service account.
  pistachio.types.v1.ServiceAccount service_account = 1;
}

// UpdateServiceAccountRequest updates an existing service account.
message UpdateServiceAccountRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];

  // New display name.
  optional string display_name = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 256
  }];

  // New description.
  optional string description = 4 [(buf.validate.field).string.max_len = 1000];

  // Whether to disable the service account.
  optional bool disabled = 5;
}

// UpdateServiceAccountResponse contains the updated service account.
message UpdateServiceAccountResponse {
  // The updated service account.
  pistachio.types.v1.ServiceAccount service_account = 1;
}

// DeleteServiceAccountRequest permanently deletes a service account.
message DeleteServiceAccountRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];
}

// DeleteServiceAccountResponse is returned after a service account is deleted.
message DeleteServiceAccountResponse {
  // Empty response. The service account has been permanently deleted.
}

// ListServiceAccountsRequest lists service accounts within a project.
message ListServiceAccountsRequest {
  // The project ID to list service accounts from.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // Pagination parameters including page size, cursor, and sort.
  //
  // Sortable fields: display_name, email, created_at, updated_at
  // Default sort: created_at DESC
  pistachio.types.v1.PaginationParams pagination = 2;
}

// ListServiceAccountsResponse contains a page of service accounts.
message ListServiceAccountsResponse {
  // The list of service accounts.
  repeated pistachio.types.v1.ServiceAccount service_accounts = 1;

  // Pagination metadata including next cursor and total count.
  pistachio.types.v1.PaginationMeta pagination = 2;
}

// SearchServiceAccountsRequest searches for service accounts within a project.
message SearchServiceAccountsRequest {
  // The project ID to search service accounts in.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // Search parameters including query, sorting, and pagination.
  //
  // Searchable fields:
  // - service_account_id: The unique identifier
  // - display_name: Human-readable display name
  // - email: Auto-generated email address
  // - description: Service account description
  // - disabled: Whether account is disabled
  // - created_at: Timestamp when created
  //
  // Sortable fields: display_name, email, created_at, updated_at
  pistachio.types.v1.SearchParams params = 2;
}

// SearchServiceAccountsResponse contains search results for service accounts.
message SearchServiceAccountsResponse {
  // The list of service accounts matching the search query.
  repeated pistachio.types.v1.ServiceAccount service_accounts = 1;

  // Pagination metadata including next cursor and total count.
  pistachio.types.v1.PaginationMeta pagination = 2;
}

// =============================================================================
// Service Account Key Operations
// =============================================================================

// GenerateServiceAccountKeyRequest generates a new key for a service account.
message GenerateServiceAccountKeyRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];

  // The algorithm for the key pair.
  // Defaults to RSA_2048 if not specified.
  pistachio.types.v1.KeyAlgorithm key_algorithm = 3;

  // Optional expiration time for the key.
  // If not set, the key does not expire.
  optional google.protobuf.Timestamp valid_before_time = 4;
}

// GenerateServiceAccountKeyResponse contains the newly generated key.
//
// IMPORTANT: The private_key_data is only returned once and cannot be retrieved again.
message GenerateServiceAccountKeyResponse {
  // The generated key metadata.
  pistachio.types.v1.ServiceAccountKey key = 1;

  // Base64-encoded private key data in PKCS#8 format.
  // IMPORTANT: This is only returned once at key creation time.
  bytes private_key_data = 2;

  // Key file for SDK authentication.
  // Contains the private key and service account metadata in a format
  // suitable for saving to a JSON file and loading with Pistachio SDKs.
  // IMPORTANT: This is only returned once at key creation time.
  google.protobuf.Struct key_file = 3;
}

// ListServiceAccountKeysRequest lists keys for a service account.
message ListServiceAccountKeysRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];
}

// ListServiceAccountKeysResponse contains the service account's keys.
message ListServiceAccountKeysResponse {
  // The list of keys.
  repeated pistachio.types.v1.ServiceAccountKey keys = 1;
}

// GetServiceAccountKeyRequest retrieves a specific key.
message GetServiceAccountKeyRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];

  // The key ID.
  // Required.
  string key_id = 3 [(buf.validate.field).string.min_len = 1];
}

// GetServiceAccountKeyResponse contains the requested key.
message GetServiceAccountKeyResponse {
  // The retrieved key metadata.
  // Note: Private key data is never returned after initial generation.
  pistachio.types.v1.ServiceAccountKey key = 1;
}

// DeleteServiceAccountKeyRequest permanently deletes a key.
message DeleteServiceAccountKeyRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];

  // The key ID.
  // Required.
  string key_id = 3 [(buf.validate.field).string.min_len = 1];
}

// DeleteServiceAccountKeyResponse is returned after a key is deleted.
message DeleteServiceAccountKeyResponse {
  // Empty response. The key has been permanently deleted.
}

// DisableServiceAccountKeyRequest disables a key without deleting it.
message DisableServiceAccountKeyRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];

  // The key ID.
  // Required.
  string key_id = 3 [(buf.validate.field).string.min_len = 1];
}

// DisableServiceAccountKeyResponse contains the disabled key.
message DisableServiceAccountKeyResponse {
  // The disabled key.
  pistachio.types.v1.ServiceAccountKey key = 1;
}

// EnableServiceAccountKeyRequest re-enables a disabled key.
message EnableServiceAccountKeyRequest {
  // The project ID that owns the service account.
  // Required. Must be a valid project ID format.
  string project_id = 1 [(buf.validate.field).string = {
    min_len: 6
    max_len: 30
    pattern: "^[a-z][a-z0-9-]{4,28}[a-z0-9]$"
  }];

  // The service account ID.
  // Required.
  string service_account_id = 2 [(buf.validate.field).string = {
    min_len: 4
    max_len: 128
    pattern: "^[a-z][a-z0-9-]{2,126}[a-z0-9]$"
  }];

  // The key ID.
  // Required.
  string key_id = 3 [(buf.validate.field).string.min_len = 1];
}

// EnableServiceAccountKeyResponse contains the re-enabled key.
message EnableServiceAccountKeyResponse {
  // The re-enabled key.
  pistachio.types.v1.ServiceAccountKey key = 1;
}
